name: Process Site Suggestions
on:
  issues:
    types: [labeled]
  workflow_dispatch:

jobs:
  check-trigger:
    runs-on: ubuntu-latest
    outputs:
      should_process: ${{ steps.check.outputs.should_process }}
    steps:
      - name: Check if we should process
        id: check
        run: |
          echo "üîç Checking trigger conditions..."
          echo "Event: ${{ github.event_name }}"
          echo "Action: ${{ github.event.action }}"
          echo "Issue Number: ${{ github.event.issue.number }}"
          echo "Label Added: ${{ github.event.label.name }}"
          echo "Issue Labels: ${{ toJson(github.event.issue.labels) }}"
          
          # Only process if the approved label was added (not removed)
          if [ "${{ github.event.label.name }}" != "approved" ]; then
            echo "‚ùå Triggered by label '${{ github.event.label.name }}', not 'approved'"
            echo "should_process=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Get label names
          LABEL_NAMES=$(echo '${{ toJson(github.event.issue.labels) }}' | jq -r '.[].name' | tr '[:upper:]' '[:lower:]' | tr '\n' ' ')
          echo "Label names (lowercase): $LABEL_NAMES"
          
          # Check for required labels and ensure not already processed
          if [[ "$LABEL_NAMES" == *"site-suggestion"* ]] && [[ "$LABEL_NAMES" == *"approved"* ]]; then
            # Check if already processed
            if [[ "$LABEL_NAMES" == *"processed"* ]] || [[ "$LABEL_NAMES" == *"auto-pr-created"* ]]; then
              echo "‚ùå Issue already processed (has processed/auto-pr-created label)"
              echo "should_process=false" >> $GITHUB_OUTPUT
            else
              echo "‚úÖ Found both 'site-suggestion' and 'approved' labels, and not processed yet"
              echo "should_process=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ùå Missing required labels"
            echo "should_process=false" >> $GITHUB_OUTPUT
          fi

  process-suggestion:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_process == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GIT_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Extract site information using Node.js
        id: extract
        run: |
          echo "üìù Processing issue #${{ github.event.issue.number }}"
          echo "Issue Title: ${{ github.event.issue.title }}"
          
          # Write issue body to a file to avoid escaping issues
          echo '${{ toJson(github.event.issue.body) }}' > issue_body.json
          
          # Use Node.js script for reliable parsing
          echo "üîÑ Using Node.js extraction script..."
          node .github/scripts/extract-issue-data.js
          
          # Clean up issue body file immediately after extraction
          rm -f issue_body.json
          echo "‚úÖ Cleaned up issue_body.json"

      - name: Read extracted data from file
        id: data
        run: |
          echo "üìñ Reading extracted data from file..."
          if [ -f "extracted_data.json" ]; then
            PROVIDER_KEY=$(jq -r '.provider_key' extracted_data.json)
            SITE_NAME=$(jq -r '.site_name' extracted_data.json)
            SITE_URL=$(jq -r '.site_url' extracted_data.json)
            SITE_STATUS=$(jq -r '.site_status' extracted_data.json)
            SITE_ICON=$(jq -r '.site_icon' extracted_data.json)
            SITE_DESCRIPTION=$(jq -r '.site_description' extracted_data.json)
            
            echo "provider_key=$PROVIDER_KEY" >> $GITHUB_OUTPUT
            echo "site_name=$SITE_NAME" >> $GITHUB_OUTPUT
            echo "site_url=$SITE_URL" >> $GITHUB_OUTPUT
            echo "site_status=$SITE_STATUS" >> $GITHUB_OUTPUT
            echo "site_icon=$SITE_ICON" >> $GITHUB_OUTPUT
            echo "site_description=$SITE_DESCRIPTION" >> $GITHUB_OUTPUT
            
            echo "‚úÖ Data loaded from file:"
            echo "Provider Key: $PROVIDER_KEY"
            echo "Site Name: $SITE_NAME"
            echo "Site URL: $SITE_URL"
            echo "Site Status: $SITE_STATUS"
          else
            echo "‚ùå extracted_data.json not found"
            exit 1
          fi

      - name: Show extracted data
        run: |
          echo "üéØ Extracted Data:"
          echo "Provider Key: ${{ steps.data.outputs.provider_key }}"
          echo "Site Name: ${{ steps.data.outputs.site_name }}"
          echo "Site URL: ${{ steps.data.outputs.site_url }}"
          echo "Site Status: ${{ steps.data.outputs.site_status }}"
          echo "Site Icon: ${{ steps.data.outputs.site_icon }}"
          echo "Site Description: ${{ steps.data.outputs.site_description }}"

      - name: Add site to providers.json
        run: |
          echo "üìù Adding site to providers.json..."
          node .github/scripts/add-site.js \
            --key "${{ steps.data.outputs.provider_key }}" \
            --name "${{ steps.data.outputs.site_name }}" \
            --url "${{ steps.data.outputs.site_url }}" \
            --status "${{ steps.data.outputs.site_status }}" \
            --icon "${{ steps.data.outputs.site_icon }}" \
            --issue "${{ github.event.issue.number }}"

      - name: Clean up temporary files
        run: |
          echo "üßπ Cleaning up temporary files..."
          # Remove temporary files used for data extraction
          rm -f extracted_data.json extracted_data.txt
          echo "‚úÖ Temporary files cleaned up"

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GIT_TOKEN }}
          commit-message: "Add site: ${{ steps.data.outputs.site_name }}"
          title: "Add ${{ steps.data.outputs.site_name }} to index"
          body: |
            Auto-generated from approved site suggestion #${{ github.event.issue.number }}
            
            - **Site:** ${{ steps.data.outputs.site_name }}
            - **URL:** ${{ steps.data.outputs.site_url }}
            - **Category:** ${{ steps.data.outputs.site_status }}
            - **Provider Key:** ${{ steps.data.outputs.provider_key }}
          branch: "add-site-${{ github.event.issue.number }}"
          delete-branch: true

      - name: Comment on issue
        if: steps.create-pr.outputs.pull-request-number != ''
        uses: actions/github-script@v6
        with:
          script: |
            const prNumber = ${{ steps.create-pr.outputs.pull-request-number }};
            console.log(`Creating comment for PR #${prNumber}`);
            
            await github.rest.issues.createComment({
              issue_number: ${{ github.event.issue.number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚úÖ Site suggestion processed! A pull request has been automatically created: #${prNumber}`
            });
            
            // Only remove approved label if it exists
            try {
              await github.rest.issues.removeLabel({
                issue_number: ${{ github.event.issue.number }},
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'approved'
              });
              console.log('‚úÖ Removed approved label');
            } catch (error) {
              console.log('‚ÑπÔ∏è  Approved label already removed or does not exist');
            }
            
            // Add processed labels
            await github.rest.issues.addLabels({
              issue_number: ${{ github.event.issue.number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['processed', 'auto-pr-created']
            });

      - name: Handle failures
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: ${{ github.event.issue.number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚ùå Automated processing failed. Please check the workflow run for details and process manually.`
            });

  debug-skip:
    if: always() && needs.check-trigger.outputs.should_process == 'false'
    needs: check-trigger
    runs-on: ubuntu-latest
    steps:
      - name: Debug skip reason
        run: |
          echo "‚ùå Workflow skipped because:"
          echo "Event: ${{ github.event_name }}"
          echo "Action: ${{ github.event.action }}"
          echo "Label Added: ${{ github.event.label.name }}"
          echo "Issue has 'site-suggestion' label: ${{ contains(github.event.issue.labels.*.name, 'site-suggestion') }}"
          echo "Issue has 'approved' label: ${{ contains(github.event.issue.labels.*.name, 'approved') }}"
          echo "Issue has 'processed' label: ${{ contains(github.event.issue.labels.*.name, 'processed') }}"
          echo "All labels: ${{ toJson(github.event.issue.labels) }}"
