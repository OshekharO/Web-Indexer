name: Process Site Suggestions
on:
  issues:
    types: [labeled]
  workflow_dispatch:

jobs:
  process-suggestion:
    if: contains(github.event.issue.labels.*.name, 'site-suggestion') && contains(github.event.issue.labels.*.name, 'approved')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          # Remove cache line since we don't have package-lock.json

      - name: Install axios (if needed)
        run: |
          # Only install if the script needs it
          if [ -f ".github/scripts/health-check.js" ]; then
            npm install axios
          fi

      - name: Extract site information from issue
        id: extract
        run: |
          ISSUE_BODY="${{ github.event.issue.body }}"
          echo "ISSUE_BODY: $ISSUE_BODY"
          
          # Extract site information using robust parsing
          SITE_NAME=$(echo "$ISSUE_BODY" | grep -i "site name" | head -1 | sed -E 's/.*\*\*(.*)\*\*.*/\1/' | sed -E 's/.*:\s*\*\*(.*)\*\*/\1/' | xargs)
          SITE_URL=$(echo "$ISSUE_BODY" | grep -i "url:" | head -1 | sed -E 's/.*\*\*(.*)\*\*.*/\1/' | sed -E 's/.*:\s*\*\*(.*)\*\*/\1/' | xargs)
          SITE_CATEGORY=$(echo "$ISSUE_BODY" | grep -i "category:" | head -1 | sed -E 's/.*\*\*(.*)\*\*.*/\1/' | sed -E 's/.*:\s*\*\*(.*)\*\*/\1/' | xargs)
          SITE_ICON=$(echo "$ISSUE_BODY" | grep -i "icon url" | head -1 | sed -E 's/.*\*\*(.*)\*\*.*/\1/' | sed -E 's/.*:\s*\*\*(.*)\*\*/\1/' | xargs)
          SITE_DESCRIPTION=$(echo "$ISSUE_BODY" | grep -i "description:" | head -1 | sed -E 's/.*\*\*(.*)\*\*.*/\1/' | sed -E 's/.*:\s*\*\*(.*)\*\*/\1/' | xargs)
          
          # Fallback parsing if above fails
          if [ -z "$SITE_NAME" ]; then
            SITE_NAME=$(echo "$ISSUE_BODY" | grep -A2 "Site Name" | grep -oP '\*\*.*?\*\*' | head -1 | sed 's/\*\*//g' | xargs)
          fi
          if [ -z "$SITE_URL" ]; then
            SITE_URL=$(echo "$ISSUE_BODY" | grep -A2 "URL" | grep -oP '\*\*.*?\*\*' | head -1 | sed 's/\*\*//g' | xargs)
          fi
          if [ -z "$SITE_CATEGORY" ]; then
            SITE_CATEGORY=$(echo "$ISSUE_BODY" | grep -A2 "Category" | grep -oP '\*\*.*?\*\*' | head -1 | sed 's/\*\*//g' | xargs)
          fi
          
          echo "Extracted - Name: '$SITE_NAME', URL: '$SITE_URL', Category: '$SITE_CATEGORY'"
          
          # Map category to status code
          case "$SITE_CATEGORY" in
            "Manga") STATUS=1 ;;
            "Light Novel"|"LN") STATUS=2 ;;
            "Movie") STATUS=3 ;;
            "App") STATUS=4 ;;
            "Anime") STATUS=5 ;;
            "Learning") STATUS=6 ;;
            "NSFW") STATUS=7 ;;
            *) STATUS=0 ;;
          esac
          
          # Generate provider key (safe version)
          PROVIDER_KEY=$(echo "$SITE_NAME" | tr '[:upper:]' '[:lower:]' | tr ' ' '_' | sed 's/[^a-z0-9_]//g')Provider
          
          echo "provider_key=$PROVIDER_KEY" >> $GITHUB_OUTPUT
          echo "site_name=$SITE_NAME" >> $GITHUB_OUTPUT
          echo "site_url=$SITE_URL" >> $GITHUB_OUTPUT
          echo "site_status=$STATUS" >> $GITHUB_OUTPUT
          echo "site_icon=$SITE_ICON" >> $GITHUB_OUTPUT
          echo "site_description=$SITE_DESCRIPTION" >> $GITHUB_OUTPUT
          echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT

      - name: Validate extracted data
        run: |
          if [ -z "${{ steps.extract.outputs.site_name }}" ]; then
            echo "❌ Error: Site name is empty"
            exit 1
          fi
          if [ -z "${{ steps.extract.outputs.site_url }}" ]; then
            echo "❌ Error: Site URL is empty"
            exit 1
          fi
          if [ "${{ steps.extract.outputs.site_status }}" = "0" ]; then
            echo "⚠️ Warning: Unknown category, using status 0"
          fi
          echo "✅ Data validation passed"

      - name: Add site to providers.json
        run: |
          node .github/scripts/add-site.js \
            --key "${{ steps.extract.outputs.provider_key }}" \
            --name "${{ steps.extract.outputs.site_name }}" \
            --url "${{ steps.extract.outputs.site_url }}" \
            --status "${{ steps.extract.outputs.site_status }}" \
            --icon "${{ steps.extract.outputs.site_icon }}" \
            --description "${{ steps.extract.outputs.site_description }}" \
            --issue "${{ steps.extract.outputs.issue_number }}"

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Add site: ${{ steps.extract.outputs.site_name }}"
          title: "Add ${{ steps.extract.outputs.site_name }} to index"
          body: |
            This PR automatically adds **${{ steps.extract.outputs.site_name }}** to the website index.
            
            - **Site:** ${{ steps.extract.outputs.site_name }}
            - **URL:** ${{ steps.extract.outputs.site_url }}
            - **Category:** ${{ steps.extractract.outputs.site_status }}
            - **Issue:** #${{ steps.extract.outputs.issue_number }}
            
            Auto-generated from approved site suggestion.
          branch: "add-site-${{ steps.extract.outputs.issue_number }}"
          delete-branch: true

      - name: Comment on issue
        if: steps.create-pr.outputs.pull-request-number != ''
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ steps.extract.outputs.issue_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `✅ Site suggestion processed! A pull request has been automatically created: #${${{ steps.create-pr.outputs.pull-request-number }}}`
            })
            
            // Remove approved label and add processed label
            github.rest.issues.removeLabel({
              issue_number: ${{ steps.extract.outputs.issue_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'approved'
            })
            
            github.rest.issues.addLabels({
              issue_number: ${{ steps.extract.outputs.issue_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['processed', 'auto-pr-created']
            })

      - name: Handle failures
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ steps.extract.outputs.issue_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `❌ Automated processing failed. Please check the workflow run for details and process manually.`
            })
